<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category Batch Manager - Preview</title>
    <link rel="stylesheet" href="css.css">
    <!-- load jquery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- load codex style -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codex/2.3.2/codex.style.min.css" />
    <!-- <script type="module" src="https://cdnjs.cloudflare.com/ajax/libs/codex/2.3.2/codex.min.js"></script> -->
</head>

<body>

    <div id="category-batch-manager" class="cbm-container">

        <div class="cbm-header">
            <h2>Category Batch Manager</h2>
            <button
                class="cdx-button cdx-button--action-default cdx-button--weight-quiet cdx-button--size-medium cdx-button--icon-only cbm-close"
                id="cbm-close" aria-label="Close">&#215;</button>
        </div>

        <div class="cbm-body">
            <div class="cbm-search">
                <div class="cdx-field">
                    <div class="cdx-label">
                        <label class="cdx-label__label" for="cbm-source-category">
                            <span class="cdx-label__label__text">Source Category</span>
                        </label>
                    </div>
                    <div class="cdx-field__control">
                        <div class="cdx-text-input">
                            <input id="cbm-source-category" class="cdx-text-input__input" type="text"
                                value="Category:Sample_Files" placeholder="Category:Example">
                        </div>
                    </div>
                </div>

                <div class="cdx-field">
                    <div class="cdx-label">
                        <label class="cdx-label__label" for="cbm-pattern">
                            <span class="cdx-label__label__text">Search Pattern</span>
                        </label>
                        <span class="cdx-label__description">
                            Enter a pattern to filter files (e.g., ,BLR.svg)
                        </span>
                    </div>
                    <div class="cdx-field__control cbm-search-row">
                        <div class="cdx-text-input" style="flex: 1;">
                            <input id="cbm-pattern" class="cdx-text-input__input" type="text"
                                placeholder="e.g., ,BLR.svg">
                        </div>
                        <button id="cbm-search-btn"
                            class="cdx-button cdx-button--action-progressive cdx-button--weight-primary cdx-button--size-medium">
                            Search
                        </button>
                    </div>
                </div>
            </div>
            <div class="cbm-results">
                <div id="cbm-results-header" class="cbm-results-header hidden">
                    <div class="cdx-info-chip cdx-info-chip--notice">
                        <span class="cdx-info-chip__text">
                            Found <strong id="cbm-count">0</strong> files
                        </span>
                    </div>
                    <button id="cbm-select-all"
                        class="cdx-button cdx-button--action-default cdx-button--weight-quiet cdx-button--size-medium">
                        Select All
                    </button>
                    <button id="cbm-deselect-all"
                        class="cdx-button cdx-button--action-default cdx-button--weight-quiet cdx-button--size-medium">
                        Deselect All
                    </button>
                </div>
                <div id="cbm-results-message" class="hidden">
                </div>
                <br>
                <div id="cbm-file-list"></div>
            </div>

            <div class="cbm-actions">
                <div class="cdx-field">
                    <div class="cdx-label">
                        <label class="cdx-label__label" for="cbm-add-cats">
                            <span class="cdx-label__label__text">Add Categories (comma-separated)</span>
                        </label>
                        <span class="cdx-label__description">
                            e.g., Category:Belarus, Category:Europe
                        </span>
                    </div>
                    <div class="cdx-field__control">
                        <div class="cdx-text-input">
                            <input id="cbm-add-cats" class="cdx-text-input__input" type="text"
                                placeholder="Category:Example">
                        </div>
                    </div>
                </div>

                <div class="cdx-field">
                    <div class="cdx-label">
                        <label class="cdx-label__label" for="cbm-remove-cats">
                            <span class="cdx-label__label__text">Remove Categories (comma-separated)</span>
                        </label>
                    </div>
                    <div class="cdx-field__control">
                        <div class="cdx-text-input">
                            <input id="cbm-remove-cats" class="cdx-text-input__input" type="text"
                                placeholder="Category:Old">
                        </div>
                    </div>
                </div>

                <div class="cdx-field">
                    <div class="cdx-label">
                        <label class="cdx-label__label" for="cbm-summary">
                            <span class="cdx-label__label__text">Edit Summary</span>
                        </label>
                    </div>
                    <div class="cdx-field__control">
                        <div class="cdx-text-input">
                            <input id="cbm-summary" class="cdx-text-input__input" type="text"
                                value="Batch category update via Category Batch Manager">
                        </div>
                    </div>
                </div>

                <div class="cbm-selected-count">
                    Selected: <strong id="cbm-selected">0</strong> files
                </div>

                <div class="cbm-buttons">
                    <button id="cbm-preview"
                        class="cdx-button cdx-button--action-default cdx-button--weight-normal cdx-button--size-medium">
                        Preview Changes
                    </button>
                    <button id="cbm-execute"
                        class="cdx-button cdx-button--action-progressive cdx-button--weight-primary cdx-button--size-medium">
                        GO
                    </button>
                </div>
            </div>

            <div id="cbm-progress" class="cbm-progress hidden">
                <div class="cdx-progress-bar cdx-progress-bar--block" role="progressbar"
                    aria-label="Batch processing progress">
                    <div id="cbm-progress-fill" class="cdx-progress-bar__bar cbm-progress-fill"></div>
                </div>
                <div id="cbm-progress-text" class="cbm-progress-text">Processing...</div>
            </div>
        </div>

        <div id="cbm-preview-modal" class="cbm-modal hidden">
            <div class="cbm-modal-content">
                <h3>Preview Changes</h3>
                <div id="cbm-preview-content"></div>
                <button id="cbm-preview-close"
                    class="cdx-button cdx-button--action-default cdx-button--weight-normal cdx-button--size-medium">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Load the main application script from modal.html -->
    <!-- <script defer src="js.js"></script> -->

    <!-- Demo-specific functions -->
    <script>
        // Mock data for preview
        const mockFiles = [
            { title: 'File:GDP-per-capita,BLR.svg', selected: false },
            { title: 'File:Life-expectancy,BLR.svg', selected: false },
            { title: 'File:Population,BLR.svg', selected: false },
            { title: 'File:Unemployment-rate,BLR.svg', selected: false },
            { title: 'File:Literacy-rate,BLR.svg', selected: false },
            { title: 'File:Infant-mortality,BLR.svg', selected: false },
            { title: 'File:CO2-emissions,BLR.svg', selected: false },
            { title: 'File:Energy-consumption,BLR.svg', selected: false },
        ];

        let currentFiles = [];

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function () {
            attachEventListeners();
            console.log('Category Batch Manager Preview - Ready');
        });

        function attachEventListeners() {
            // Search button
            document.getElementById('cbm-search-btn').addEventListener('click', handleSearch);

            // Pattern input - Enter key
            document.getElementById('cbm-pattern').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') handleSearch();
            });

            // Select/Deselect all
            document.getElementById('cbm-select-all').addEventListener('click', selectAll);
            document.getElementById('cbm-deselect-all').addEventListener('click', deselectAll);

            // Preview and Execute
            document.getElementById('cbm-preview').addEventListener('click', handlePreview);
            document.getElementById('cbm-execute').addEventListener('click', handleExecute);

            // Close buttons
            document.getElementById('cbm-close').addEventListener('click', close);
            document.getElementById('cbm-preview-close').addEventListener('click', hidePreviewModal);

            // Close modal when clicking outside
            document.getElementById('cbm-preview-modal').addEventListener('click', function (e) {
                if (e.target.id === 'cbm-preview-modal') {
                    hidePreviewModal();
                }
            });
        }

        function handleSearch() {
            const pattern = document.getElementById('cbm-pattern').value.trim();

            clearMessage();
            showLoading();

            // Simulate API delay
            setTimeout(function () {
                // Filter files by pattern
                currentFiles = pattern
                    ? mockFiles.filter(f => f.title.includes(pattern))
                    : [...mockFiles];

                if (currentFiles.length === 0) {
                    showMessage('No files found matching the pattern.', 'error');
                    document.getElementById('cbm-results-header').classList.add('hidden');
                } else {
                    showMessage(`Found ${currentFiles.length} files matching the pattern.`, 'success');
                    document.getElementById('cbm-results-header').classList.remove('hidden');
                    document.getElementById('cbm-count').textContent = currentFiles.length;
                }

                renderFileList();
                hideLoading();
            }, 500);
        }

        function renderFileList() {
            const listContainer = document.getElementById('cbm-file-list');
            listContainer.innerHTML = '';

            if (currentFiles.length === 0) {
                return;
            }

            currentFiles.forEach(function (file, index) {
                const fileRow = document.createElement('div');
                fileRow.className = 'cbm-file-row';
                fileRow.innerHTML = `
                    <input type="checkbox" class="cbm-file-checkbox" id="file-${index}"
                        ${file.selected ? 'checked' : ''}>
                    <label for="file-${index}">${file.title}</label>
                    <button class="cbm-remove-btn" data-index="${index}">×</button>
                `;
                listContainer.appendChild(fileRow);
            });

            // Attach checkbox listeners
            document.querySelectorAll('.cbm-file-checkbox').forEach(function (checkbox) {
                checkbox.addEventListener('change', function (e) {
                    const index = parseInt(e.target.id.replace('file-', ''));
                    currentFiles[index].selected = e.target.checked;
                    updateSelectedCount();
                });
            });

            // Attach remove button listeners
            document.querySelectorAll('.cbm-remove-btn').forEach(function (btn) {
                btn.addEventListener('click', function (e) {
                    const index = parseInt(e.target.dataset.index);
                    removeFile(index);
                });
            });

            updateSelectedCount();
        }

        function removeFile(index) {
            currentFiles.splice(index, 1);
            document.getElementById('cbm-count').textContent = currentFiles.length;
            renderFileList();

            if (currentFiles.length === 0) {
                document.getElementById('cbm-results-header').classList.add('hidden');
                showMessage('All files removed.', 'notice');
            }
        }

        function selectAll() {
            currentFiles.forEach(f => f.selected = true);
            document.querySelectorAll('.cbm-file-checkbox').forEach(cb => cb.checked = true);
            updateSelectedCount();
        }

        function deselectAll() {
            currentFiles.forEach(f => f.selected = false);
            document.querySelectorAll('.cbm-file-checkbox').forEach(cb => cb.checked = false);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selectedCount = currentFiles.filter(f => f.selected).length;
            document.getElementById('cbm-selected').textContent = selectedCount;
        }

        function getSelectedFiles() {
            return currentFiles.filter(f => f.selected);
        }

        function handlePreview() {
            const selectedFiles = getSelectedFiles();

            if (selectedFiles.length === 0) {
                showMessage('Please select at least one file.', 'warning');
                return;
            }

            const toAdd = parseCategories(document.getElementById('cbm-add-cats').value);
            const toRemove = parseCategories(document.getElementById('cbm-remove-cats').value);

            if (toAdd.length === 0 && toRemove.length === 0) {
                showMessage('Please specify categories to add or remove.', 'warning');
                return;
            }

            showLoading();

            // Simulate preview generation
            setTimeout(function () {
                const preview = selectedFiles.map(function (file) {
                    return {
                        file: file.title,
                        currentCategories: ['Belarus', 'Economic Data'],
                        newCategories: ['Belarus', 'Economic Data', ...toAdd].filter(c => !toRemove.includes(c)),
                        willChange: true
                    };
                });

                showPreviewModal(preview);
                hideLoading();
            }, 300);
        }

        function showPreviewModal(preview) {
            const modal = document.getElementById('cbm-preview-modal');
            const content = document.getElementById('cbm-preview-content');

            let html = '<table class="cbm-preview-table">';
            html += '<tr><th>File</th><th>Current Categories</th><th>New Categories</th></tr>';

            preview.forEach(function (item) {
                if (item.willChange) {
                    html += `
                        <tr>
                            <td>${item.file}</td>
                            <td>${item.currentCategories.join(', ')}</td>
                            <td>${item.newCategories.join(', ')}</td>
                        </tr>
                    `;
                }
            });

            html += '</table>';

            const changesCount = preview.filter(p => p.willChange).length;
            html = `<p><strong>${changesCount} files</strong> will be modified</p>` + html;

            content.innerHTML = html;
            modal.classList.remove('hidden');
        }

        function hidePreviewModal() {
            document.getElementById('cbm-preview-modal').classList.add('hidden');
        }

        function handleExecute() {
            const selectedFiles = getSelectedFiles();

            if (selectedFiles.length === 0) {
                showMessage('Please select at least one file.', 'warning');
                return;
            }

            const toAdd = parseCategories(document.getElementById('cbm-add-cats').value);
            const toRemove = parseCategories(document.getElementById('cbm-remove-cats').value);

            if (toAdd.length === 0 && toRemove.length === 0) {
                showMessage('Please specify categories to add or remove.', 'warning');
                return;
            }

            const summary = document.getElementById('cbm-summary').value.trim();
            if (!summary) {
                showMessage('Please provide an edit summary.', 'warning');
                return;
            }

            if (!confirm(`Are you sure you want to update ${selectedFiles.length} files?`)) {
                return;
            }

            showProgress();
            clearMessage();

            // Simulate batch processing
            let processed = 0;
            const total = selectedFiles.length;
            const interval = setInterval(function () {
                processed++;
                const percentage = Math.round((processed / total) * 100);
                updateProgress(percentage, { success: processed, failed: 0 });

                if (processed >= total) {
                    clearInterval(interval);
                    setTimeout(function () {
                        hideProgress();
                        showResults({
                            success: processed,
                            failed: 0,
                            skipped: 0
                        });
                    }, 500);
                }
            }, 200);
        }

        function showProgress() {
            document.getElementById('cbm-progress').classList.remove('hidden');
            updateProgress(0, { success: 0, failed: 0 });
        }

        function hideProgress() {
            document.getElementById('cbm-progress').classList.add('hidden');
        }

        function updateProgress(percentage, results) {
            document.getElementById('cbm-progress-fill').style.width = percentage + '%';
            document.getElementById('cbm-progress-text').textContent =
                `Processing... ${percentage}% (${results.success} succeeded, ${results.failed} failed)`;
        }

        function showResults(results) {
            const message = `
                Batch operation completed!
                <br>✅ Success: ${results.success}
                <br>❌ Failed: ${results.failed}
                <br>⏭️ Skipped: ${results.skipped}
            `;
            showMessage(message, 'success');
        }

        function showMessage(text, type) {
            const container = document.getElementById('cbm-results-message');
            container.classList.remove('hidden');

            const typeClass = type === 'error' ? 'cdx-message--error'
                : type === 'warning' ? 'cdx-message--warning'
                    : type === 'success' ? 'cdx-message--success'
                        : 'cdx-message--notice';

            container.innerHTML = `
                <div class="cdx-message cdx-message--block ${typeClass}" role="alert">
                    <span class="cdx-message__icon"></span>
                    <div class="cdx-message__content">${text}</div>
                </div>
            `;
        }

        function clearMessage() {
            const container = document.getElementById('cbm-results-message');
            container.innerHTML = '';
            container.classList.add('hidden');
        }

        function showLoading() {
            const listContainer = document.getElementById('cbm-file-list');
            listContainer.innerHTML = `
                <div class="cdx-progress-bar cdx-progress-bar--inline" role="progressbar" aria-label="Loading">
                    <div class="cdx-progress-bar__bar"></div>
                </div>
            `;
        }

        function hideLoading() {
            // Loading will be replaced by renderFileList()
        }

        function parseCategories(input) {
            if (!input || !input.trim()) {
                return [];
            }

            return input.split(',')
                .map(cat => cat.trim())
                .filter(cat => cat.length > 0)
                .map(cat => {
                    // Normalize category names
                    if (!cat.startsWith('Category:')) {
                        cat = 'Category:' + cat;
                    }
                    // Remove "Category:" prefix for internal use
                    return cat.replace(/^Category:/i, '');
                });
        }

        function close() {
            if (confirm('Are you sure you want to close? Unsaved changes will be lost.')) {
                document.getElementById('category-batch-manager').style.display = 'none';
            }
        }
    </script>
</body>

</html>
